/*! Realtime Post View Counter by GiaHuy.Net */
(function () {
  'use strict';
  if (typeof ghViews === 'undefined' || typeof ghViews.firebaseUrl === 'undefined') return;
  if (ghViews.sharedBy !== 'www.giahuy.net') {
    window.location.href = "https://www.giahuy.net/p/credit.html";
    return;
  }
  const config = {
    databaseUrl: ghViews.firebaseUrl.replace(/\/$/, ''),
    abbreviation: !!ghViews.abbreviation,
    lazyload: !!ghViews.lazyload
  };
  const abbr = (val) => {
    const e = Math.sign(Number(val));
    return Math.abs(val) >= 1e9 ? e * (Math.abs(val) / 1e9).toFixed(1) + 'B'
         : Math.abs(val) >= 1e6 ? e * (Math.abs(val) / 1e6).toFixed(1) + 'M'
         : Math.abs(val) >= 1e3 ? e * (Math.abs(val) / 1e3).toFixed(1) + 'K'
         : val;
  };
  const initFirebase = (cb) => {
    const load = (src, id, next) => {
      if (document.getElementById(id)) return next();
      const s = document.createElement('script');
      s.src = src; s.async = true; s.id = id;
      s.onload = next;
      document.head.appendChild(s);
    };
    load("https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js", "firebase-app", () => {
      load("https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js", "firebase-db", cb);
    });
  };
  const updateViews = () => {
    const app = firebase.initializeApp({ databaseURL: config.databaseUrl }, "ghViewApp");
    const db = app.database();
    document.querySelectorAll(".ghViews").forEach(el => {
      const path = el.getAttribute("data-path");
      if (!path) return;
      const ref = db.ref(path);
      ref.once("value", snap => {
        let count = snap.exists() ? snap.val() : 0;
        if (el.getAttribute("data-incr") === "true") {
          ref.set(count + 1);
          count++;
        }
        el.setAttribute("data-view", config.abbreviation ? abbr(count) : count);
        el.classList.add("ghVc");
      });
    });
  };
  const run = () => initFirebase(updateViews);
  if (config.lazyload) {
    let triggered = false;
    const trigger = () => { if (!triggered) { triggered = true; run(); } };
    window.addEventListener("scroll", trigger, { once: true });
    window.addEventListener("click", trigger, { once: true });
    if (document.readyState === "complete") trigger();
  } else run();
})();
