/*! Realtime Download Counter © Giahuy.net (v2.0) */
(function () {
  if (!ghDownloads || ghDownloads.sharedBy !== 'www.giahuy.net') return;

  const dbUrl = ghDownloads.firebaseUrl.replace(/\/$/, '');

  const loadScript = (src, id, cb) => {
    if (document.getElementById(id)) return cb();
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.id = id;
    s.onload = cb;
    document.head.appendChild(s);
  };

  const assignPostData = () => {
    try {
      const data = window._WidgetManager._GetAllData();
      const blogId = "BLOG_" + data.blog.blogId;
      const postId = "POST_" + data.blog.postId;

      document.querySelectorAll(".download").forEach(el => {
        if (!el.getAttribute("data-blog")) el.setAttribute("data-blog", blogId);
        if (!el.getAttribute("name")) el.setAttribute("name", postId);
      });
    } catch (e) {
      console.warn("Không thể lấy BlogID hoặc PostID.");
    }
  };

  const abbr = (val) => {
    const e = Math.sign(Number(val));
    return 1e9 <= Math.abs(val)
      ? e * (Math.abs(val) / 1e9).toFixed(1) + 'B'
      : 1e6 <= Math.abs(val)
      ? e * (Math.abs(val) / 1e6).toFixed(1) + 'M'
      : 1e3 <= Math.abs(val)
      ? e * (Math.abs(val) / 1e3).toFixed(1) + 'K'
      : val;
  };

  loadScript("https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js", "fb-app", () => {
    loadScript("https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js", "fb-db", () => {
      const app = firebase.initializeApp({ databaseURL: dbUrl }, "ghDownloadApp");
      const db = app.database();

      assignPostData();

      document.querySelectorAll(".ghBox .download").forEach(btn => {
        const blog = btn.getAttribute("data-blog");
        const post = btn.getAttribute("name");
        const file = btn.getAttribute("data-file") || '';
        if (!file) return console.warn("Thiếu data-file");
        const safeFile = file.replace(/[.#$/\[\]/]/g, '_'); // ✅ sửa lỗi path
        const path = `ghDownloads/${blog}/${post}_${safeFile}`;
        const counter = btn.closest(".ghBox").querySelector(".dlCount");

        // Hiển thị lượt tải
        db.ref(path).once("value", snap => {
          const val = snap.exists() ? snap.val() : 0;
          if (counter) counter.textContent = abbr(val) + " lượt tải";
        });

        // Khi người dùng click
        btn.addEventListener("click", function (e) {
          e.preventDefault();

          db.ref(path).once("value", snap => {
            const current = snap.exists() ? snap.val() : 0;
            db.ref(path).set(current + 1);
            if (counter) counter.textContent = abbr(current + 1) + " lượt tải";

            const realLink = btn.getAttribute("data-link");
            if (realLink) {
              window.location.href = realLink;
            } else {
              alert("Không tìm thấy liên kết tải.");
            }
          });
        });
      });
    });
  });
})();
