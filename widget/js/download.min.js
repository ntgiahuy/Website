/*! Realtime Download Counter by GiaHuy.Net */
(function () {
  if (!ghDownloads || ghDownloads.sharedBy !== 'www.giahuy.net') return;

  const dbUrl = ghDownloads.firebaseUrl.replace(/\/$/, '');
  const loadScript = (src, id, cb) => {
    if (document.getElementById(id)) return cb();
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.id = id;
    s.onload = cb;
    document.head.appendChild(s);
  };

  loadScript("https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js", "fb-app", () => {
    loadScript("https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js", "fb-db", () => {
      const app = firebase.initializeApp({ databaseURL: dbUrl }, "ghDownloadApp");
      const db = app.database();

      document.querySelectorAll(".ghBox .download").forEach(btn => {
        const blog = btn.getAttribute("data-blog");
        const post = btn.getAttribute("name");
        const file = btn.getAttribute("data-file");
        const path = `ghDownloads/${blog}/${post}_${file}`;
        const counter = btn.closest(".ghBox").querySelector(".dlCount");

        // Hiển thị lượt tải
        db.ref(path).once("value", snap => {
          const val = snap.exists() ? snap.val() : 0;
          counter.textContent = val + " lượt tải";
        });

        // Xử lý khi nhấn
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          db.ref(path).once("value", snap => {
            const current = snap.exists() ? snap.val() : 0;
            db.ref(path).set(current + 1);
            counter.textContent = (current + 1) + " lượt tải";

            // Hành vi tải thực tế
            alert("File sẽ được tải... (demo)");
            // window.location.href = "https://link-tai-thuc-te.com/" + file;
          });
        });
      });
    });
  });
})();
